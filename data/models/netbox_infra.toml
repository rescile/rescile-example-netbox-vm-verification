# --- Chunk 1: Create 'server' resources from NetBox VMs ---
origin_resource = "netbox_vms"

[[create_resource]]
resource_type = "server"
relation_type = "_DEFINED_BY"
name = "{{ origin_resource.name }}"
[create_resource.properties]
cluster = "{{ origin_resource.cluster }}"
os_type = "{{ origin_resource.os_type }}"
owner_slug = "{{ origin_resource.owner_slug }}"

# --- Chunks 2, 3, 4: Enrich 'server' with team data, IP, and network info ---
origin_resource = "server"

# --- Enrich 'server' with team data ---
[[enrich_property]]
from_resource_type = "teams"
origin_key = "owner_slug"
target_key = "slug"
property_to_copy = "business_unit"

# --- Link 'server' to its 'ip_address' ---
# This finds the ip_address whose `assigned_to_vm` property matches the server's name
# and creates a HAS_IP link from the server to the IP address.
[[enrich_property]]
from_resource_type = "netbox_ips"
origin_key = "name"
target_key = "assigned_to_vm"
relation_type = "HAS_IP"
reverse_relation = false # Create edge from server -> ip_address

# --- Propagate network info up to the server ---
# This powerful two-step subscription pulls a property from a grandchild node.
# Step 1: Subscribe 'server' to the 'network_name' from its child 'ip_address'.
[[subscribe_property]]
origin_resource_type = "netbox_ips"
origin_property = "network_name"
target_resource_type = "server"
target_property = "network_name"

# Step 2: Use the newly acquired 'network_name' to enrich 'server' with properties
# from the corresponding 'netbox_networks' node.
[[enrich_property]]
from_resource_type = "netbox_networks"
origin_key = "network_name"
target_key = "name"
property_to_copy = "has_internet_access"
