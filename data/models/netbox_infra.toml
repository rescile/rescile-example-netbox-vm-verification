# --- Chunk 1: Create 'server' resources from NetBox VMs ---
origin_resource = "netbox_vms"

[[create_resource]]
resource_type = "server"
relation_type = "_DEFINED_BY"
name = "{{ origin_resource.name }}"
[create_resource.properties]
cluster = "{{ origin_resource.cluster }}"
os_type = "{{ origin_resource.os_type }}"
owner_slug = "{{ origin_resource.owner_slug }}"

# --- Enrich IP addresses with network information first ---
# This ensures that when we link servers to IPs, the network data is already present.
origin_resource = "netbox_ips"

[[link_resources]]
with = "netbox_networks"
on = { local = "network_name", remote = "name" }
copy_properties = [ "has_internet_access" ]

# --- Enrich 'server' resources with team, IP, and network info ---
origin_resource = "server"

# --- Link 'server' with 'teams' to copy the business_unit ---
[[link_resources]]
with = "teams"
on = { local = "owner_slug", remote = "slug" }
copy_properties = [ "business_unit" ]

# --- Link 'server' to its IP and copy up network info ---
# This finds the `netbox_ips` resource whose `assigned_to_vm` property matches the
# server's name, creates a HAS_IP link, and copies the `has_internet_access`
# property that was previously joined onto the `netbox_ips` resource. This avoids
# complex template-based traversals.
[[link_resources]]
with = "netbox_ips"
on = { local = "name", remote = "assigned_to_vm" }
create_relation = { type = "HAS_IP" }
copy_properties = [ "has_internet_access" ]
